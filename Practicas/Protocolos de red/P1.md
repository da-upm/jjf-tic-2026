# Práctica 1 - Conexión SSH y gestión de usuarios

## Introducción

Antes de empezar con la práctica, se pueden consultar en [este enlace](https://cheatography.com/davechild/cheat-sheets/linux-command-line/) los comandos más utilizados en Linux.

Por convención se va a utilizar **Servidor** para referirnos a la máquina a la que nos hemos conectado mediante SSH, identificado con el símbolo `$` al inicio de los comandos a ejecutar. Cuando sea la máquina propia del usuario, se identificarán los comandos mediante `upm>`.

> Es importante no copiar estos símbolos de la práctica a la terminal.

## Creación de un usuario con contraseña

Para entrar en el servidor por primera vez hay que ejecutar el siguiente comando con los datos que hay en el excel. Después de ejecutarlo, pedirá la contraseña que también se encuentra en el excel.

```bash
upm> ssh <user_xls>@<ip_xls>
```

Para crear un usuario, escoged un nombre identificativo para el usuario y crearlo mediante:

```bash
$ sudo adduser <user_name> 
```

> La primera vez que ejecutáis `sudo` os pedirá una contraseña, esta es la del usuario con el que habéis accedido por SSH.

Este comando, además de crear el usuario, genera automáticamente el directorio de inicio `/home/<user_name>`.

Una vez se ha creado el usuario, hay que asignarle una contraseña. Después de introducirlo, pedirá la contraseña y comprobación de que la misma es correcta.

```bash
$ sudo passwd <user_name>
```

Actualmente el usuario se ha creado y tiene contraseña asignada, por lo que podremos usar sus credenciales para iniciar sesión. Antes de eso, es importante asignarle permisos para poder administrar el equipo.

Con el siguiente comando añadiremos al nuevo usuario al grupo `sudo` de superusuarios (administradores):

```bash
$ sudo usermod -aG sudo <user_name>
```

Una vez el usuario está generado, se podrá acceder al servidor con el nombre y la clave escogidos.

> Se pueden abrir varias terminales simultáneas en el mismo ordenador.

```bash
upm> ssh <user_name>@<ip_xls>
```

Para comprobar los permisos de superusario, debe emplearse el comando:

```bash
$ sudo -l
```

> Para terminar una conexión ssh o cerrar el terminal, se puede usar el comando `exit`.

## Creación de un usuario con clave pública

La creación del usuario y la asignación de permisos serán los mismos, se modificará la forma de autenticación.

Previo a la generación del usuario, hay que generar un par de claves SSH.

```bash
upm> ssh-keygen -t ecdsa -b 521 
```

> Recomendamos el uso de una contraseña para cifrar el fichero.

Una vez tenemos el par de claves, generamos otro usuario:

| Tarea: Generar un nuevo usuario empleando el comando utilizado en el apartado anterior. |
| --- |

<textarea style="border: 1px solid #ccc; background-color: #f9f9f9; font-family: 'Courier New', Courier, monospace; font-size: 14px; padding: 5px; width: 100%; box-sizing: border-box; resize: vertical; outline: none;" placeholder="$> ">
</textarea>
---

Vamos a tener que añadir nuestra clave pública generada al servidor, para ello, leeremos la clave pública mediante el siguiente comando:

```bash
upm> type C:\Users\<user_windows>\.ssh\<file>.pub
```

> **Importante** que sea la clave pública (fichero .pub).

> En Linux sería `cat /home/<user_linux>/.ssh/<file>.pub`.

Se copia la cadena de caracteres que aparece por pantalla en el servidor, en el archivo */home/<user_name_2>/.ssh/authorized_keys*.

> Para copiar y pegar en el terminal hay que pulsar el *shift* además del *ctrl + C* o *ctrl + V*

```bash
$ sudo nano /home/<user_name_2>/.ssh/authorized_keys
```

> Si la carpeta `.ssh` no existe, puede crearse mediante el comando `mkdir`.

> Una vez se ha copiado, se cierra el terminal con *ctrl + X*. Pedirá confirmación de guardado, en español es *ctrl + S* y en inglés es *ctrl + Y*. Comprobar abajo a la izquierda del terminal.

En este momento estaría el fichero creado con la clave introducida,pero no funcionaría. Esto se debe a los permisos por defecto con los que se crea, por lo que debemos asignarle unos permisos personalizados. En este caso lo haremos con el siguiente comando:

```bash
$ sudo chmod 600 /home/<user_name_2>/.ssh/authorized_keys
```

> Para más información sobre los permisos se puede consultar el [siguiente enlace](https://cets.seas.upenn.edu/answers/chmod.html)

Una vez hemos configurado el acceso por clave pública y privada, le asignamos los permisos al usuario.

| Tarea: Añadir el nuevo usuario al grupo `sudo`. |
| --- |

<textarea style="border: 1px solid #ccc; background-color: #f9f9f9; font-family: 'Courier New', Courier, monospace; font-size: 14px; padding: 5px; width: 100%; box-sizing: border-box; resize: vertical; outline: none;" placeholder="$> ">
</textarea>
---

A continuación podemos probar a conectarnos al servidor mediante `ssh`. Veremos que ahora no nos pide contraseña del usuario, nos pedirá la contraseña del archivo (si la hemos establecido).

```bash
upm> ssh -i "C:\Users\<user_windows>\.ssh\<file>" <user_name_2>@<ip_xls>
```

## Opcional: Gestión de grupos

Dentro de la gestión de permisos, existe el término "grupos" para organizar y administrar a los usuarios. Los grupos de Linux permiten asignar permisos a ciertos usuarios pertenecientes al mismo grupo para acceder o modificar los recursos del sistema.

Para aprender cómo funcionan los grupos, crearemos un directorio compartido, le asignaremos un grupo y veremos el comportamiento del mismo con los usuarios que se encuentran en él o no.

Creamos el directorio llamado *compartido*.

```bash
$ sudo mkdir /compartido
```

> Al crearla con `sudo`, esta carpeta pertenece al usuario `root` al ser creada con privilegios de superusuario.

Crearemos el grupo.

```bash
$ sudo groupadd <group_name>
```

Una vez se ha creado el directorio y el grupo, hay que asigarle al directorio el grupo al que pertenece, para ello ejecutaremos.

```bash
$ sudo chown :<group_name> /compartido
```

> Un directorio solo puede estar asignado a un grupo. Para comprobar el propietario y el grupo podemos emplear `ls -la`. Se puede consultar más información de los campos que aparecen al ejecutar `ls -la` en el [siguiente enlace](https://unix.stackexchange.com/questions/103114/what-do-the-fields-in-ls-al-output-mean).

> El comando `chown` sirve para cambiar tanto al propietario como al grupo de uno o más archivos o directorios. `chown` es abreviatura de "change owner". La sintáxis completa del comando sería `sudo chown <user>:<group> <path>`.

Una vez tenemos asignado el grupo al directorio, vamos a asignar a uno de nuestros usuarios al grupo, para ello, hay que cambiar los permisos del usuario como ya hicimos anteriormente pero en este caso le añadiremos el grupo que hemos generado.

| Tarea: Añadir el nuevo usuario al nuevo grupo creado. |
| --- |

<textarea style="border: 1px solid #ccc; background-color: #f9f9f9; font-family: 'Courier New', Courier, monospace; font-size: 14px; padding: 5px; width: 100%; box-sizing: border-box; resize: vertical; outline: none;" placeholder="$> ">
</textarea>
---

> Este comando es el mismo que cuando ortorgamos permisos de superusuario, pero indicando otro `<group>` donde anteriormente pusimos `sudo`. Esto es porque en Linux asignarle el grupo `sudo` a un usuario implica darle permisos de privilegios de superusuario.

Ahora, vamos a comprobar el funcionamiento de los grupos. Con **ambos usuarios** vamos a intentar acceder a la carpeta:

```bash
$ cd /compartido
```

Y ahora intentaremos crear un archivo:

```bash
$ touch <file>.txt
```

---
Jornadas de Formación TIC 2024 - Delegación de Alumnos UPM

![Creative Commons "Attribution-Share Alike" license icon](https://upload.wikimedia.org/wikipedia/commons/e/e5/CC_BY-SA_icon.svg)
